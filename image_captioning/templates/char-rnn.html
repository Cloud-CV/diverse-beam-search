{% load staticfiles %}

<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>CloudCV: Large Scale Distributed Computer Vision as a cloud service</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
<meta charset="utf-8">
<meta name="description" content="CloudCV: Large Scale Distributed Computer Vision as a Cloud Service">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap styles -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="http://cloudcv.org/static/css/blueimp-gallery.min.css">

<link rel="stylesheet" href="http://cloudcv.org/static/css/blueimp-gallery.min.css">
<link rel="stylesheet" href="http://cloudcv.org/static/css/jquery.fileupload-ui.css">

<link rel="stylesheet" href="{% static "css/vis_style.css" %}">s
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

</head>
<style>
    .button_link {
    cursor: pointer;
    }
    .demo_img{
    height: 300px !important;
        padding: 6px;

    }
    .demo_img:hover {
    border: 6px solid black;
        padding: 0px;
    cursor: pointer;
    }
    #show-demo-images-btn{
        text-align: right;
    }
    @media(max-width: 540px){
        #show-demo-images-btn{
          text-align: center;

        }
    }
</style>
<body id="body">
<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-fixed-top .navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">CloudCV</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li id="image-stitching"><a  href="/image-stitch">Image Stitching</a></li>
                <li id = "decaf-server"><a  href="/decaf-server">Decaf-Server</a></li>
                <li id = "classification" ><a href="/classify">Classification</a></li>
                <li id = "poi"><a href="/vip">VIP</a></li>
                <li id="trainaclass"><a href="/trainaclass">Train a new category</a></li>
                <li id="vqa"><a href="/vqa">VQA</a></li>
                <li id="neuraltalk2"><a href="/vis">NeuralTalk2</a></li>
                <li id="char-rnn"><a href="/neuraltalk2">Char-rnn</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="socket-error" class="modal hide fade" tabindex="-1" data-width="760">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3>Socket Error</h3>
  </div>
  <div class="modal-body">
    <div class="row-fluid">
        Socket connection cannot be established on port 8000 which is required to communicate with the CloudCV Servers. Please make sure that port 8000 is open and not blocked by firewall on your system.<br>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" data-dismiss="modal" class="btn">Close</button>
  </div>
</div>

<div class="container">
    <div class="page-header">
            <h1 align="center">CloudCV: Diverse Beam Search</h1>
            <h3 align="center">More details about beam search can be found <a href="http://visualqa.org/">here.</a></h3>
            <h3 align="center">Lorem ipsum dolor sit amet, consectetur adipiscing elit <a href="#">here</a></h3>
            <br>
            <font size="4">
                <p style="text-align:center;">
                    <span style="font-size: 14px;">Browsers currently supported: Google Chrome, Mozilla Firefox</span>
                </p>
            </font>
    </div>
</div>

<div class="container">
        <div class="page-header">
          <h2 id="userImages">Try CloudCV DBS On Your Images</h2>
        </div>

        <form id="fileupload" name="prefixForm" method="post" action="." enctype="multipart/form-data">

          <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}'/>
          <input type="hidden" name="socketid-hidden" value="test" id="socketid" value="$csrf_token"/>
          <div class="form-inline">
            
          <div class="row">
          <label for="prefixField">Prefix text<input type="text" value="They " class="form-control" id="prefixField" name="prefix"></label>
          
          <label for="B">Beams<input type="number" value="12" class="form-control" name="B" id="BField"></label> 
          

          <label for="G">Groups<input type="number" value="3" class="form-control" name="G" id="GField"></label>
            <label for="T">Time Steps<input type="number" class="form-control" value="35" name="T" id="TField"></label>
          </div>            

          <div class="row">
            <label for="lambda">Lambda<input type="number" value="0.5" name="lambda" class="form-control" id="lambdaField" step="0.00000001"></label>

            <label for="ngram_length">Ngram Length<input type="number" value="1" name="ngram_length" class="form-control" id="ngramLengthField"></label><br>

          <label for="divmode">Div Mode</label>
          <input type="radio" value="0" name="divmode" checked="checked"> no cumulative diversity
          <input type="radio" value="1" name="divmode"> cumulative diversity
          <input type="radio" value="2" name="divmode"> ngram diversity
          <input type="radio" value="3" name="divmode"> word2vec diversity
          <br>
          <input class="btn btn-primary" type="submit" value="Submit">
          </div>
          

          </div>
        </form>
        <div class="fileupload-content" id="uploadImageUsingDragAndDrop">
            <table class="files"></table>
            <div class="fileupload-progressbar"></div>
        </div>
        <br>
    </div>
</div>

<div class="container">
    <div class="page-header">

        <h3 id="termstart">Terminal: </h3>

        <div id="Console"
             style="height:300px; color: #FFFFFF; background-color: #2B2A2B; overflow:scroll; padding: 10px;">
            <ul id="comments" style='list-style-type:none;'>
            </ul>
        </div>
        <br>

        <div id="underTheHood">
            <p><h3>How it works</h3></p>
            <font size="4">
                <ol>
                    <li>You upload an image.</li>
                    <li>Your request is sent to our servers with GPUs courtesy NVIDIA.</li>
                    <li>Our servers run our deep-learning based <a class="button_link" onclick="scrollToElement($('#creditSection'))">Diverse Beam Search algorithm.</a></li>
                    <li>Results and updates are shown in real-time.</li>    
                </ol>
            </font><br><br>
        </div>

        <h3>Results of Diverse beam search </h3><br>

        <div id="ResultImage" class="row" style="padding-bottom:100px;">
        </div>

        <div id="creditSection">
       <h3> Credits </h3>
            <font size="4">
        <a href="#">Diverse Beam Search</a><br>
            Michael Cogswell, Dhruv Batra, Devi Parikh
       </font>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="{% static "js/vis.js"%}"></script>
<script type="text/javascript">
var chart = beam_search_vis()
            .width(window.innerWidth)
            .height(window.innerHeight - 200);

$(document).ready(function() {
    // insert application dependent form
    var app = "char-rnn";

    // load data and start the vis
    var data_url = getParameterByName("data");
    if (data_url) {
        d3.json(data_url, function(error, data) {
            if (error) throw error;
            bsvis(data, app);
        });
    } else {
        // var request_data = make_request_data(app);
        // change_vis_data(request_data, app);
    }

    // update vis data asynchronously
    $('form[name=prefixForm]').submit(function(e){
        console.log("Prefix form submission working properly.");
        e.preventDefault();
        var request_data = make_request_data(app);
        change_vis_data(request_data, app);
    });     
});         

function make_request_data(app) {
    var request_data = new FormData();
    var B = parseInt($("#BField")[0].value);
    var G = parseInt($("#GField")[0].value);
    if(B % G !== 0) {
        alert('The number of groups must divide the number of beams (i.e. B % G == 0).');
        return;
    }
    request_data.append("csrfmiddlewaretoken", '{{ csrf_token }}');
    request_data.append("B", $("#BField")[0].value);
    request_data.append("G", $("#GField")[0].value);
    request_data.append("lmbda", $("#lambdaField")[0].value);
    request_data.append("ngram_length", $("#ngramLengthField")[0].value);
    request_data.append("divmode", $("input:radio[name=divmode]:checked").val());
    request_data.append("app", app);
    request_data.append("prefix", $("#prefixField")[0].value);
    if (app == 'char-rnn') {
        request_data.append("T", $("#TField")[0].value);
    } else if (app == 'neuraltalk2') {
        request_data.append("img_fname", "cat.jpg");
        img_field = $("#imgField")[0];
        if (img_field.files.length) {
            request_data.append("img", img_field.files[0]);
        }
    }
    return request_data;
}

function change_vis_data(request_data, app) {
    $.ajax({
        type: 'POST',
        cache: false,
        url: '/vis/beam_search/',
        data: request_data,
        processData: false,
        contentType: false,
        success: function(data) {
            bsvis(data, app);
        },
        error: function(data) {
            console.log(data);
        }
    });
}

function bsvis(data, app) {
    var sel = d3.select("#ResultImage").selectAll("div")
                .data([deep_copy(data)]);
    sel.enter().append("div")
            .attr("class", "top-div");
    sel.exit().remove();
    sel.selectAll("*").remove();
    chart(sel, app);
    d3.select("#resetButton")
        .on("click", function() {
            bsvis(deep_copy(data), app);
        });
}

// http://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-clone-an-object
function deep_copy(obj) {
    var new_obj = jQuery.extend(true, {}, obj);
    return new_obj;
}
</script>

<script type="text/javascript">
  //  Comment out this script portion once we need to give fucntionality of sending images using the input field.
  // $('input:radio[name="imageUplaodMethod"]').change(
  //   function(){
  //       if ($(this).is(':checked') && $(this).val() == 'url') {
  //         $("#uploadImageUsingDragAndDrop").hide();
  //         $("#uploadImageUsingUrl").show();
  //       }
  //       else if ($(this).is(':checked') && $(this).val() == 'dragAndDrop') {
  //         $("#uploadImageUsingUrl").hide();
  //         $("#uploadImageUsingDragAndDrop").show();
  //       }
  //   });
</script>
</body>
</html>
